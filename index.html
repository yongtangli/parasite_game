<!DOCTYPE html>
<html lang="zh-TW"> <!-- Changed lang to Traditional Chinese -->
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="Parasite Game">
    <meta name="keywords" content="parasites">
    <link rel="icon" href="icon.png" type="image/png">
    <script type="text/JavaScript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.js"></script>
    <title>Parasite Quiz</title>
    <!-- Using a simple sans-serif font stack -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Germgoth';
            src: url('fonts/Germgoth.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        /* --- Refined Styles for Sophistication & Elegance --- */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Using Cormorant Garamond for headings and Inter for body */
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #F9F7F3; /* Elegant warm off-white */
            color: #404040; /* Dark gray for text */
        }

        /* Title Styling with Germgoth */
        .flashcard-title, .start-title {
            font-family: "Germgoth", serif; /* Using the provided gothic font */
            color: #383838; /* Slightly darker heading color */
            font-weight: normal; /* Germgoth might only have one weight */
            letter-spacing: 0.5px; /* Subtle spacing */
            text-align: center;
            padding-bottom: 5px; /* Space below title */
            /* Removed text-shadow for cleaner look */
        }

        .start-title {
            font-size: 2.8rem; /* Larger start title */
            margin-bottom: 40px; /* More space below */
        }

        .flashcard-title {
            font-size: 1.8rem; /* Slightly larger in-game title */
            margin-bottom: 15px; /* Adjusted space */
        }

        /* Start screen styles */
        .start-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            animation: fadeIn 0.8s ease-out forwards; /* Fade in start screen */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .start-button {
            padding: 14px 35px; /* Generous padding */
            font-size: 1.1rem;
            font-weight: 500;
            background-color: #6D8A96; /* Muted Blue-Gray */
            color: #ffffff;
            border: none;
            border-radius: 8px; /* Consistent radius */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .start-button:hover {
            background-color: #5A7580; /* Darker shade */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px); /* Subtle lift */
        }

        .start-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .footer {
            position: absolute;
            bottom: 15px; /* Slightly higher */
            width: 100%;
            text-align: center;
            font-size: 0.85rem; /* Smaller font */
            color: #999; /* Lighter gray */
        }

        .footer a {
            color: #888; /* Slightly darker link */
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .footer a:hover {
            color: #6D8A96; /* Accent color on hover */
            text-decoration: none; /* Keep no underline */
        }

        /* Game Screen */
        .flashcard-container {
            width: 100%;
            height: 100%;
            display: none; /* Hidden initially */
            flex-direction: column;
            background-color: #F9F7F3; /* Match body background */
            padding: 25px; /* Slightly more padding */
            position: relative;
            max-width: 1400px; /* Slightly narrower max width */
            margin: 0 auto; /* Center container */
            opacity: 0;
            animation: fadeIn 0.6s 0.2s ease-out forwards; /* Delayed fade in */
        }

        /* Progress Bar Area */
        .progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 18px; /* More space below */
            gap: 15px;
        }

        .progress-item {
            display: flex;
            align-items: center;
            padding: 8px 15px; /* Adjusted padding */
            border-radius: 20px; /* More rounded */
            font-size: 0.95rem;
            font-weight: 500;
            background-color: transparent; /* No background */
            color: #666; /* Muted text color */
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            border: 1px solid #E0E0E0; /* Subtle border */
        }

        .progress-item:hover {
            background-color: #FFFFFF; /* White background on hover */
            border-color: #D0D0D0;
            transform: scale(1.03); /* Slight scale effect */
        }

        .progress-number-orange {
            margin-right: 8px;
            color: #D98C60; /* Muted Orange */
            font-weight: 600;
            font-size: 1rem;
        }

        .progress-number-green {
            margin-left: 8px;
            color: #79A88F; /* Muted Green */
            font-weight: 600;
            font-size: 1rem;
        }

        /* Image Area */
        .card-content {
            position: relative;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            margin-bottom: 20px; /* Adjusted space */
            border-radius: 10px; /* Slightly larger radius */
            background-color: #FFFFFF; /* White background for card */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.07); /* Soft shadow */
            border: 1px solid #EAEAEA; /* Very light border */
        }

        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9); /* Semi-transparent white */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            border-radius: 10px; /* Match parent */
            transition: opacity 0.3s ease-out;
        }

        .spinner {
            border: 4px solid #E0E0E0;
            border-top: 4px solid #6D8A96; /* Accent color spinner */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; /* Smoother spin */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-content img {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
            border-radius: 10px; /* Match container */
        }

        .card-content img.loaded {
            opacity: 1;
        }

        /* Answer Area */
        .your-answer-label {
            font-size: 0.8rem; /* Smaller label */
            font-weight: 500;
            color: #888; /* Lighter gray */
            margin-bottom: 6px;
            text-transform: uppercase; /* Uppercase for style */
            letter-spacing: 0.5px;
            padding-left: 5px;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease; /* Delay visibility change */
        }

        .answer-input-container {
            margin-bottom: 20px; /* More space below input */
            transition: visibility 0s linear 0.3s, opacity 0.3s ease; /* Delay visibility change */
        }

        .answer-input {
            width: 100%;
            padding: 14px 18px; /* More padding */
            font-size: 1.05rem; /* Slightly larger text */
            border: 1px solid #D8D8D8; /* Lighter border */
            border-radius: 8px;
            background-color: #FFFFFF; /* White background */
            color: #404040; /* Dark gray text */
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            appearance: none; /* Remove default styles */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) inset; /* Subtle inner shadow */
        }

        .answer-input::placeholder {
            color: #B0B0B0; /* Lighter placeholder */
            font-weight: 400;
        }

        .answer-input:focus {
            border-color: #6D8A96; /* Accent color border */
            box-shadow: 0 0 0 3px rgba(109, 138, 150, 0.15), 0 1px 3px rgba(0, 0, 0, 0.05) inset; /* Focus ring + inner shadow */
        }

        /* Bottom Buttons Area */
        .bottom-buttons {
            display: flex;
            justify-content: space-between; /* Space between Don't Know and Answer */
            align-items: center;
            gap: 12px;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease; /* Delay visibility change */
        }

        .dont-know-button, .answer-button {
            padding: 12px 24px; /* Adjusted padding */
            font-size: 1rem;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .dont-know-button {
            background-color: transparent;
            color: #6D8A96; /* Accent color */
            border: 1px solid transparent; /* Placeholder for smooth transition */
        }

        .dont-know-button:hover {
            color: #5A7580; /* Darker accent */
            background-color: rgba(109, 138, 150, 0.08); /* Very subtle background */
            transform: scale(1.02); /* Slight scale */
        }

        .answer-button {
            background-color: #6D8A96; /* Muted Blue-Gray */
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .answer-button:hover {
            background-color: #5A7580; /* Darker shade */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px); /* Subtle lift */
        }

        .dont-know-button:active, .answer-button:active {
            transform: scale(0.98); /* Keep slight scale down */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Answer Display Area */
        .card-answer {
            display: none; /* Initially hidden */
            position: absolute;
            /* Position it over the input/button area */
            bottom: 25px; /* Match container padding */
            left: 25px;
            right: 25px;
            background-color: rgba(249, 247, 243, 0.85); /* Semi-transparent background matching page */
            backdrop-filter: blur(8px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(8px); /* Safari support */
            padding: 20px;
            border-radius: 10px;
            border: none; /* Delete border */
            font-size: 1.05rem; /* Match input text size */
            z-index: 3;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(10px);
            animation: fadeSlideIn 0.4s ease-out forwards;
            color: #404040; /* Ensure text readability */
            text-align: center;
        }

        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #showAnswer strong { /* Style Correct/Incorrect/Answer labels */
             font-weight: 600;
             margin-right: 5px;
        }
        #showAnswer strong[style*="#10B981"] { color: #60A77C !important; } /* Muted Green */
        #showAnswer strong[style*="#EF4444"] { color: #C76D6D !important; } /* Muted Red */
        #showAnswer strong[style*="#F59E0B"] { color: #C9875A !important; } /* Muted Orange */


        #showExplanation {
            font-size: 0.9rem;
            color: #555;
            line-height: 1.5;
            margin-top: 5px;
            max-height: 100px; /* Limit height if needed */
            overflow-y: auto; /* Add scroll if explanation is long */
        }
         #showExplanation strong {
            font-weight: 600;
            color: #404040;
         }
         /* Style for the contribution link */
         #showExplanation .contribute-link {
            color: #6D8A96;
            cursor: pointer;
            text-decoration: underline;
            font-weight: 500;
            margin-left: 5px; /* Space before link */
         }
         #showExplanation .contribute-link:hover {
            color: #5A7580;
         }

        /* Styles for the contribution input area */
        .contribution-area {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee; /* Separator */
            display: flex;
        }
        .contribution-area input {
            flex: 1;
            padding: 8px 12px;
            font-size: 0.95rem;
            border: 1px solid #D8D8D8;
            border-radius: 6px;
            background-color: #FFFFFF;
            color: #404040;
            outline: none;
            resize: vertical; /* Allow vertical resizing */
            margin-right: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05) inset;
        }
        .contribution-area input:focus {
            border-color: #6D8A96;
            box-shadow: 0 0 0 3px rgba(109, 138, 150, 0.15), 0 1px 3px rgba(0, 0, 0, 0.05) inset;
        }
        .contribution-area button {
            padding: 8px 18px;
            font-size: 0.9rem;
            font-weight: 500;
            background-color: #6D8A96;
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            float: right; /* Position button to the right */
        }
        .contribution-area button:hover {
            background-color: #5A7580;
        }
        .contribution-area button:active {
            transform: scale(0.97);
        }

        /* Next Button */
        .next-button {
            display: block;
            padding: 10px 22px;
            font-size: 1rem; /* Slightly smaller than main button */
            font-weight: 500;
            background-color: transparent;
            color: #6D8A96; /* Accent color */
            border: 1px solid #B0C0C8; /* Border matching accent */
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            align-self: center; /* Center the button */
            margin-top: 15px; /* Space above button */
            /* Remove flashy effects */
        }

        .next-button:hover {
            background-color: #6D8A96;
            color: white;
            border-color: #6D8A96;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(109, 138, 150, 0.2);
        }

        .next-button:active {
            transform: scale(0.97);
            box-shadow: none;
        }

        /* Modal styles (for wrong/correct lists) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(40, 40, 40, 0.6); /* Darker overlay */
            justify-content: center;
            align-items: center;
            opacity: 0;
            animation: fadeInModal 0.4s ease forwards;
        }

        @keyframes fadeInModal {
            from { opacity: 0; }
            to { opacity: 1; }
        }


        .modal-content {
            width: 90%;
            max-width: 650px; /* Slightly wider modal */
            max-height: 85%;
            overflow-y: auto;
            background-color: #FDFBF8; /* Slightly different off-white for modal */
            padding: 30px; /* More padding */
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            position: relative;
            transform: scale(0.95);
            animation: scaleUpModal 0.4s ease forwards;
        }

         @keyframes scaleUpModal {
            from { transform: scale(0.95); opacity: 0;}
            to { transform: scale(1); opacity: 1;}
         }


        .close {
            position: absolute;
            top: 15px; /* Position adjustment */
            right: 20px;
            font-size: 2rem; /* Larger close icon */
            font-weight: 300; /* Thinner X */
            color: #AAAAAA;
            cursor: pointer;
            line-height: 1;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .close:hover {
             color: #6D8A96; /* Accent color on hover */
             transform: rotate(90deg); /* Rotate effect */
        }

        .modal-content h2 {
          font-size: 1.5rem; /* Larger modal title */
          margin-bottom: 20px;
          color: #383838;
          font-weight: 600; /* Slightly bolder */
          border-bottom: 1px solid #EAEAEA; /* Separator line */
          padding-bottom: 10px;
        }

        .modal-content p {
          font-size: 1rem;
          line-height: 1.7; /* More line spacing */
          margin-bottom: 15px;
          color: #505050; /* Slightly lighter text */
        }

        .modal-content ol {
            padding-left: 25px; /* Indent list */
            margin-bottom: 16px;
        }

        .modal-content li {
            margin-bottom: 25px; /* More space between list items */
            padding-bottom: 20px;
            border-bottom: 1px solid #EAEAEA;
            list-style-type: decimal; /* Ensure numbers are shown */
        }

         .modal-content li:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

         .modal-content li p {
            margin-bottom: 8px; /* Less space between text within li */
         }
         .modal-content li p strong {
             color: #404040;
         }
         .modal-content li em { /* Style explanation hint */
            color: #777;
         }

        .modal-content img {
            max-width: 150px; /* Smaller image size in list */
            height: auto;
            margin-bottom: 12px; /* Adjusted margin */
            border-radius: 6px; /* Smaller radius */
            border: 1px solid #E0E0E0; /* Consistent border */
            display: block; /* Prevent extra space */
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        /* Utility for hiding elements visually but keeping accessible */
        .sr-only {
          position: absolute;
          width: 1px;
          height: 1px;
          padding: 0;
          margin: -1px;
          overflow: hidden;
          clip: rect(0, 0, 0, 0);
          white-space: nowrap;
          border-width: 0;
        }

        /* Hide input area when answer is shown using visibility and opacity */
        .answer-input-container[style*="hidden"],
        .bottom-buttons[style*="hidden"],
        .your-answer-label[style*="hidden"] {
            opacity: 0;
            visibility: hidden;
            transition: visibility 0s linear 0.3s, opacity 0.3s ease;
        }

        /* --- REMOVED Swear Word Warning Modal Styles --- */

        /* --- REMOVED Shake Animation --- */

        /* --- Dark Theme Styles --- */
        @media (prefers-color-scheme: dark) {
            /* Dark theme variables (condensed for brevity) */
            :root {
                --dark-bg-primary: #121212; --dark-bg-secondary: #1e1e1e; --dark-text-primary: #e0e0e0;
                --dark-text-secondary: #a0a0a0; --dark-text-muted: #757575; --dark-border-primary: #383838;
                --dark-border-secondary: #505050; --dark-accent-blue: #7aa0b2; --dark-accent-blue-hover: #95b9cd;
                --dark-accent-green: #87c7a8; --dark-accent-orange: #eaa67a; --dark-accent-red: #e08484;
                --dark-shadow-color: rgba(0, 0, 0, 0.5); --dark-focus-ring: rgba(122, 160, 178, 0.3);
            }
            html, body { background-color: var(--dark-bg-primary); color: var(--dark-text-primary); }
            .flashcard-title, .start-title { color: var(--dark-text-primary); }
            .start-button { background-color: var(--dark-accent-blue); color: var(--dark-bg-primary); box-shadow: 0 2px 5px var(--dark-shadow-color); }
            .start-button:hover { background-color: var(--dark-accent-blue-hover); box-shadow: 0 4px 8px var(--dark-shadow-color); }
            .footer { color: var(--dark-text-muted); } .footer a { color: var(--dark-text-secondary); } .footer a:hover { color: var(--dark-accent-blue-hover); }
            .flashcard-container { background-color: var(--dark-bg-primary); }
            .progress-item { color: var(--dark-text-secondary); border: 1px solid var(--dark-border-primary); }
            .progress-item:hover { background-color: var(--dark-bg-secondary); border-color: var(--dark-border-secondary); color: var(--dark-text-primary); }
            .progress-number-orange { color: var(--dark-accent-orange); } .progress-number-green { color: var(--dark-accent-green); }
            .card-content { background-color: var(--dark-bg-secondary); box-shadow: 0 4px 15px var(--dark-shadow-color); border: 1px solid var(--dark-border-primary); }
            .loading-screen { background-color: rgba(30, 30, 30, 0.9); }
            .spinner { border: 4px solid var(--dark-border-primary); border-top: 4px solid var(--dark-accent-blue); }
            .card-content img { background-color: var(--dark-bg-secondary); }
            .your-answer-label { color: var(--dark-text-secondary); }
            .answer-input { background-color: var(--dark-bg-secondary); color: var(--dark-text-primary); border: 1px solid var(--dark-border-secondary); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) inset; }
            .answer-input::placeholder { color: var(--dark-text-muted); }
            .answer-input:focus { border-color: var(--dark-accent-blue); box-shadow: 0 0 0 3px var(--dark-focus-ring), 0 1px 3px rgba(0, 0, 0, 0.3) inset; }
            .dont-know-button { color: var(--dark-accent-blue); }
            .dont-know-button:hover { color: var(--dark-accent-blue-hover); background-color: rgba(122, 160, 178, 0.15); }
            .answer-button { background-color: var(--dark-accent-blue); color: var(--dark-bg-primary); box-shadow: 0 2px 5px var(--dark-shadow-color); }
            .answer-button:hover { background-color: var(--dark-accent-blue-hover); box-shadow: 0 4px 8px var(--dark-shadow-color); }
            .card-answer { background-color: rgba(42, 42, 42, 0.9); color: var(--dark-text-primary); box-shadow: 0 5px 20px var(--dark-shadow-color); border: 1px solid var(--dark-border-secondary); }
            #showAnswer strong[style*="#10B981"] { color: var(--dark-accent-green) !important; }
            #showAnswer strong[style*="#EF4444"] { color: var(--dark-accent-red) !important; }
            #showAnswer strong[style*="#F59E0B"] { color: var(--dark-accent-orange) !important; }
            #showExplanation { color: var(--dark-text-secondary); }
            #showExplanation strong { color: var(--dark-text-primary); }
            #showExplanation .contribute-link { color: var(--dark-accent-blue); } /* Dark theme contribute link */
            #showExplanation .contribute-link:hover { color: var(--dark-accent-blue-hover); }
            .contribution-area { border-top: 1px solid var(--dark-border-primary); } /* Dark theme separator */
            .contribution-area input { background-color: var(--dark-bg-secondary); color: var(--dark-text-primary); border: 1px solid var(--dark-border-secondary); box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) inset; }
            .contribution-area input:focus { border-color: var(--dark-accent-blue); box-shadow: 0 0 0 3px var(--dark-focus-ring), 0 1px 3px rgba(0, 0, 0, 0.3) inset; }
            .contribution-area button { background-color: var(--dark-accent-blue); color: var(--dark-bg-primary); }
            .contribution-area button:hover { background-color: var(--dark-accent-blue-hover); }
            .next-button { color: var(--dark-accent-blue); border: 1px solid var(--dark-accent-blue); }
            .next-button:hover { background-color: var(--dark-accent-blue); color: var(--dark-bg-primary); border-color: var(--dark-accent-blue); box-shadow: 0 2px 6px rgba(122, 160, 178, 0.3); }
            .modal { background-color: rgba(18, 18, 18, 0.75); }
            .modal-content { background-color: var(--dark-bg-secondary); box-shadow: 0 8px 30px var(--dark-shadow-color); border: 1px solid var(--dark-border-primary); }
            .close { color: var(--dark-text-secondary); } .close:hover { color: var(--dark-accent-blue-hover); }
            .modal-content h2 { color: var(--dark-text-primary); border-bottom: 1px solid var(--dark-border-primary); }
            .modal-content p { color: var(--dark-text-primary); }
            .modal-content li { border-bottom: 1px solid var(--dark-border-primary); }
            .modal-content li p strong { color: var(--dark-text-primary); }
            .modal-content li em { color: var(--dark-text-secondary); }
            .modal-content img { border: 1px solid var(--dark-border-secondary); box-shadow: 0 2px 5px var(--dark-shadow-color); background-color: #2a2a2a; }
            /* --- REMOVED Dark theme swear modal styles --- */
        }

    </style>
</head>
<body onload="init();"> <!-- Keep onload or move init() call inside script -->

    <!-- Start Screen -->
    <div class="start-screen">
        <div class="start-title">Parasitology</div>
        <button id="startGame" class="start-button">開始吧</button>
        <div class="footer">
          <a href="https://christmaskid.github.io/parasite_game/" target="_blank">前往初版</a> ｜
          <a href="https://line.me/ti/p/~jedieason" target="_blank">問題回報</a> ｜
          <a href="profile.mobileconfig" download="Parasite.mobileconfig">蘋果下載</a>
        </div>
    </div>

    <!-- Game Screen -->
    <div class="flashcard-container">
        <div class="progress">
            <div class="progress-item" id="wrongArea">
                <span class="progress-number-orange" id="wrong">0</span>
                <span>你錯的</span>
            </div>
            <div class="progress-item" id="correctArea">
                <span>你對的</span>
                <span class="progress-number-green" id="correct">0</span>
            </div>
        </div>

        <div class="card-content">
            <div class="loading-screen">
                <div class="spinner"></div>
            </div>
            <img id="image" onload="this.classList.add('loaded'); document.querySelector('.loading-screen').style.display='none';" src="" alt="Parasite Image">
        </div>

        <div class="card-answer"> <!-- This div appears when showing answer -->
            <div id="showAnswer"></div>
            <div id="showExplanation">
                <!-- Explanation (or contribution UI) appears here -->
            </div>
            <button id="next" class="next-button">下一個</button>
        </div>

        <div class="your-answer-label">這是什麼？</div>
        <div class="answer-input-container">
            <input id="answer" type="text" placeholder="把答案打在這" class="answer-input">
        </div>

        <div class="bottom-buttons">
            <button id="dontKnow" class="dont-know-button">母災</button>
            <button id="submitAnswer" class="answer-button">確定</button>
        </div>
    </div>

    <!-- Modal (for wrong/correct lists) -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">×</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- REMOVED Swear Word Warning Modal HTML -->

    <script>
        // --- Game Variables ---
        var TIME = 31;
        var numOfProbs;
        var tm;
        var data;
        var x; // index of current question
        var state = 0;
        var correct = 0;
        var wrong = 0;
        var total = 0;
        var viewing = false;
        var done;
        var correctList = [];
        var wrongList = [];

        // List of swear words (lowercase)
        const lowerCaseSwearWords = [
            "幹", "靠", "操", "媽的", "他媽的", "幹你娘", "機掰", "雞掰", "哭邀", "靠北", "靠腰",
            "操你媽", "王八蛋", "他媽", "賤人", "婊子", "俗辣", "垃圾", "智障", "白痴", "腦殘",
            "低能", "肏", "淦", "靠杯", "三小", "啥小", "死", "屁", "幹您娘", "操機掰", "娘砲", "破麻",
            "操你妈", "干", "他妈", "傻逼", "脑残", "屌",
            "fuck", "fucking", "shit", "bitch", "damn", "asshole", "cunt", "fucker", "motherfucker",
            "dick", "pussy", "wank", "slut", "whore"
        ].map(word => word.toLowerCase());

        // REMOVED Swear modal variables

        // --- NEW: Google Apps Script Function ---
        function sendToGoogleDocs(content) {
            const url = 'https://script.google.com/macros/s/AKfycbzWbgs69CkM1nsQKCdtSp26b0LKmCqpzqlAnuetqzgqfd3KVkcZSjWB19vmNhcvlXeO/exec'; // Your Apps Script URL
            const submitButton = document.getElementById('submit-explanation-button'); // Get button if exists
            if (submitButton) submitButton.disabled = true; // Disable button while sending

            fetch(url, {
                method: 'POST',
                mode: 'no-cors', // Important for sending to Apps Script without complex CORS setup, but means no response readable
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({ content: content })
            })
            .then(() => {
                // Since mode is 'no-cors', we can't read the response. Assume success.
                console.log("Data likely sent successfully (no-cors mode).");
                hideContributionInput(); // Hide the input area after successful send
            })
            .catch(error => {
                console.error('Error sending data:', error);
                alert('送出詳解時發生錯誤，請稍後再試。'); // Provide error feedback
                if (submitButton) submitButton.disabled = false; // Re-enable button on error
            });
        }


        function parseMultiAns(data) {
            if (!data) return [];
            Object.values(data).forEach(item => {
                if (item && typeof item.answer === 'string') {
                    item.answer = item.answer.split(" / ").map(s => s.trim()).filter(s => s);
                } else if (!item || typeof item.answer === 'undefined') {
                    item.answer = [];
                }
            });
            return data;
        }

        function enterKeyEvent(event) {
            if (event.key === 'Enter') {
                 if (!viewing && document.getElementById("answer").value.trim() !== "") {
                    submitUserAnswer();
                } else if (viewing && document.querySelector('.card-answer').style.display === 'flex') { // Ensure answer is visible
                    nextProb();
                }
            }
        }

        function init() {
            $(document).ready(function () {
                $.get("./answersheet.csv")
                    .done(function (CSVdata) {
                        try {
                            data = $.csv.toObjects(CSVdata);
                            numOfProbs = data.length;
                            if (numOfProbs === 0) throw new Error("No data loaded from CSV.");
                            data = parseMultiAns(data);

                            var btn = document.getElementById("startGame");
                            var startHandler = function () {
                                document.querySelector('.start-screen').style.display = 'none';
                                document.querySelector('.flashcard-container').style.display = 'flex';
                                document.removeEventListener("keypress", enterPressStart);
                                state = 1;
                                done = new Array(numOfProbs).fill(false);
                                correct = 0; wrong = 0; total = 0;
                                document.getElementById("correct").innerHTML = correct;
                                document.getElementById("wrong").innerHTML = wrong;
                                correctList = []; wrongList = [];
                                startGame();
                            };

                            var enterPressStart = function (event) {
                                if (event.key === 'Enter') startHandler();
                            };

                            btn.addEventListener("click", startHandler);
                            document.addEventListener("keypress", enterPressStart);

                            // --- REMOVED Swear Modal Initialization ---

                        } catch (error) {
                            console.error("Error processing CSV data:", error);
                            alert("Failed to load or process game data.");
                            document.getElementById("startGame").disabled = true;
                            document.getElementById("startGame").textContent = "讀取錯誤";
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("Failed to load answersheet.csv:", textStatus, errorThrown);
                        alert("無法讀取 answersheet.csv");
                         document.getElementById("startGame").disabled = true;
                         document.getElementById("startGame").textContent = "讀取錯誤";
                    });

                adjustPlaceholder();
            });
            window.addEventListener('resize', adjustPlaceholder);
        }

        function startGame() {
            document.addEventListener("keydown", enterKeyEvent);
            document.getElementById("submitAnswer").addEventListener("click", submitUserAnswer);
            document.getElementById("dontKnow").addEventListener("click", showAnswer);
            document.getElementById("next").addEventListener("click", nextProb);
            document.getElementById('wrongArea').addEventListener('click', showWrongList);
            document.getElementById('correctArea').addEventListener('click', showCorrectList);
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('modal').style.display = "none";
            });

            window.addEventListener('click', function(event) {
                let regularModal = document.getElementById('modal');
                if (event.target === regularModal) {
                    regularModal.style.display = "none";
                }
                 // REMOVED Background click close for swear modal
            });

            document.addEventListener("keydown", function(e) {
                const answerInput = document.getElementById("answer");
                const explanationInput = document.getElementById("explanation-input");
                 // Allow '/' to focus main answer OR explanation input if it's visible
                 if (e.key === "/" && document.activeElement !== answerInput && document.activeElement !== explanationInput) {
                    e.preventDefault();
                    // Prioritize explanation input if visible
                    if (explanationInput && explanationInput.offsetParent !== null) { // Check if visible
                        explanationInput.focus();
                    } else {
                        answerInput.focus();
                    }
                }
            });

            nextProb();
        }

        function checkAns(input, ansArr) {
            if (!Array.isArray(ansArr)) return false;
            const normalizedInput = input.trim().toLowerCase();
            return ansArr.some(ans => ans.trim().toLowerCase() === normalizedInput);
        }

        function updateCorrect() {
            correct++; document.getElementById("correct").innerHTML = correct;
            if (data[x]) correctList.push(data[x]);
        }

        function updateWrong() {
            wrong++; document.getElementById("wrong").innerHTML = wrong;
             if (data[x]) wrongList.push(data[x]);
        }

        // --- **** MODIFIED FUNCTION **** ---
        function submitUserAnswer() {
            var userAnswerRaw = document.getElementById("answer").value;
            var lowerUserAnswer = userAnswerRaw.trim().toLowerCase();

            // --- REDIRECT LOGIC ---
            // Check if the lowercase input contains any swear words
            if (lowerUserAnswer && lowerCaseSwearWords.some(swearWord => lowerUserAnswer.includes(swearWord))) {
                 // Open YouTube in a new tab
                window.open('https://youtu.be/HmIMmFAV4BY', '_blank');
                // Optional: You might want to clear the input field or give some feedback in the original window
                document.getElementById("answer").value = "";
                // alert("偵測到不雅字詞，已開啟新視窗。");
                return; // Stop further execution of this function in the current window
            }
            // --- END REDIRECT LOGIC ---

            // If no swear word, continue with the original game logic
            if (viewing) return;
            clearTimeout(tm);

            var userAnswer = userAnswerRaw;
            if (userAnswer.trim() === "") return; // Don't submit empty answers

            viewing = true;
            document.querySelector('.answer-input-container').style.visibility = 'hidden';
            document.querySelector('.bottom-buttons').style.visibility = 'hidden';
            document.querySelector('.your-answer-label').style.visibility = 'hidden';

            var showAnsDiv = document.getElementById("showAnswer");
            var cardAnswerDiv = document.querySelector(".card-answer");
            cardAnswerDiv.style.display = "flex";

            if (checkAns(userAnswer, data[x].answer)) {
                showAnsDiv.innerHTML = `<strong style="color: #10B981;">對了欸！！🥹</strong> 答案是：${data[x].answer.join(' / ')}`;
                hideExplanation(); // Hide explanation area if correct
                updateCorrect();
            } else {
                showAnsDiv.innerHTML = `<strong style="color: #EF4444;">錯了錯了😭</strong> 正確答案是：${data[x].answer.join(' / ')}`;
                showExplanation(); // Show explanation if wrong
                updateWrong();
            }

            total++;
            checkCompletion();
        }
        // --- **** END MODIFIED FUNCTION **** ---

        // Simplified: Always hide explanation area initially
        function hideExplanation() {
            const expDiv = document.getElementById("showExplanation");
            expDiv.innerHTML = ""; // Clear content
            expDiv.style.display = "none"; // Hide container
        }

        function showAnswer() { // For "Don't Know"
            if (viewing) return;
            clearTimeout(tm);

            viewing = true;
            document.querySelector('.answer-input-container').style.visibility = 'hidden';
            document.querySelector('.bottom-buttons').style.visibility = 'hidden';
            document.querySelector('.your-answer-label').style.visibility = 'hidden';

            var showAnsDiv = document.getElementById("showAnswer");
            var cardAnswerDiv = document.querySelector(".card-answer");
            cardAnswerDiv.style.display = "flex";

            showAnsDiv.innerHTML = `<strong style="color: #F59E0B;">答案：</strong>${data[x].answer.join(' / ')}`;
            showExplanation(); // Always show explanation for "Don't Know"
            updateWrong();

            total++;
            checkCompletion();
        }

        // --- MODIFIED: Show Explanation OR Contribution UI ---
        function showExplanation() {
            var expDiv = document.getElementById("showExplanation");
            expDiv.innerHTML = ''; // Clear previous content
            const explanationText = data[x]?.explanation?.trim();
            const hasExplanation = explanationText && explanationText !== "\"\"" && explanationText !== "\"\""; // Fixed check

            if (hasExplanation) {
                const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                expDiv.innerHTML = `<strong>偷偷告訴你為什麼：</strong>${sanitizedExplanation}`;
            } else {
                // No explanation: Show message and contribution link/area
                expDiv.innerHTML = `
                    <span id="no-explanation-message">
                        <i>這題還沒有詳解⋯不過你可以</i><span class="contribute-link" onclick="showContributionInput()">貢獻一下！</span>
                    </span>
                    <div class="contribution-area" id="contribution-area" style="display: none;">
                        <input id="explanation-input" placeholder="請輸入你的詳解⋯"></input>
                        <button id="submit-explanation-button" onclick="submitContribution()">送出</button>
                    </div>
                `;
            }
            expDiv.style.display = "block"; // Ensure the container is visible
        }

        // --- NEW: Function to show the contribution input ---
        function showContributionInput() {
            const contribArea = document.getElementById('contribution-area');
            const noExplanationMsg = document.getElementById('no-explanation-message');
            if (contribArea) {
                contribArea.style.display = 'flex';
                // Optionally hide the initial message/link
                if(noExplanationMsg) noExplanationMsg.style.display = 'none';
                // Focus the textarea
                const textarea = document.getElementById('explanation-input');
                if(textarea) textarea.focus();
            }
        }

        // --- NEW: Function to hide the contribution input ---
        function hideContributionInput() {
            const contribArea = document.getElementById('contribution-area');
            const noExplanationMsg = document.getElementById('no-explanation-message');
             const textarea = document.getElementById('explanation-input');
             const submitButton = document.getElementById('submit-explanation-button');

            if (contribArea) {
                contribArea.style.display = 'none';
                if (textarea) textarea.value = ''; // Clear textarea
                 if (submitButton) submitButton.disabled = false; // Re-enable button
            }
             // Optionally show the initial message again (or a thank you message)
             if (noExplanationMsg) {
                noExplanationMsg.style.display = 'inline'; // Or block depending on original style
                noExplanationMsg.innerHTML = '<i>感謝你的貢獻！</i>'; // Change message after sending
            }
        }

        // --- NEW: Function to handle contribution submission ---
        function submitContribution() {
            const explanationInput = document.getElementById('explanation-input');
            const explanation = explanationInput.value.trim();

            if (!explanation) {
                alert("請輸入詳解內容！");
                explanationInput.focus();
                return;
            }

            if (!data || data[x] === undefined) {
                alert("無法獲取當前問題資料，無法送出。");
                return;
            }

            const currentItem = data[x];
            const num = currentItem.num || ''; // Use empty string if undefined
            const path = currentItem.path || '';
            const answer = Array.isArray(currentItem.answer) ? currentItem.answer.join(' / ') : (currentItem.answer || '');
            const description = currentItem.description || ''; // Use description field if it exists

            // Format: num,path,answer,description,explanation
            const content = `${num},${path},${answer},${description},${explanation}`;

            console.log("Sending content:", content); // For debugging
            sendToGoogleDocs(content);
        }

        function nextProb() {
            document.querySelector('.card-answer').style.display = 'none';
            document.querySelector('.answer-input-container').style.visibility = 'visible';
            document.querySelector('.bottom-buttons').style.visibility = 'visible';
            document.querySelector('.your-answer-label').style.visibility = 'visible';

            viewing = false;
            resetTime();
            countdown();
            updateImage();
            document.getElementById("answer").value = "";
            document.getElementById("answer").focus();
            document.getElementById("showAnswer").innerHTML = "";
            document.getElementById("showExplanation").innerHTML = "";
            document.getElementById("showExplanation").style.display = "none"; // Ensure explanation area is hidden initially
        }

        function checkCompletion() {
             const allDone = done.every(status => status === true);
             if (allDone) {
                 alert("恭喜你完成了！🎉重新開始吧嘿嘿！！");
                 done.fill(false);
                 total = 0;
                 // Optionally clear correct/wrong lists?
                 // correctList = [];
                 // wrongList = [];
             }
        }

        function pickNewImage() {
            const availableIndices = [];
            for (let i = 0; i < numOfProbs; i++) {
                if (!done[i]) availableIndices.push(i);
            }

            if (availableIndices.length === 0) {
                console.warn("All questions shown, restarting cycle.");
                checkCompletion();
                // Recalculate after reset
                for (let i = 0; i < numOfProbs; i++) if (!done[i]) availableIndices.push(i);
                if (availableIndices.length === 0) return -1;
            }

            const randomIndex = Math.floor(Math.random() * availableIndices.length);
            const selectedIndex = availableIndices[randomIndex];
            done[selectedIndex] = true;
            return selectedIndex;
        }

        function updateImage() {
            document.querySelector('.loading-screen').style.display = 'flex';
            var imageElement = document.getElementById("image");
            imageElement.classList.remove('loaded');
            imageElement.src = ""; // Clear src

            x = pickNewImage(); // Get index of the CURRENT question
             if (x === -1) {
                console.error("Could not pick a new image index.");
                document.querySelector('.loading-screen').style.display = 'none';
                return;
            }

            const picref = data[x]?.path;

            if (picref) {
                 imageElement.setAttribute('src', picref);
                 const altText = data[x]?.answer?.[0] || `Parasite image ${x + 1}`;
                 imageElement.setAttribute('alt', `Image for: ${altText}`);
            } else {
                 console.warn(`No image path found for index ${x}.`);
                 imageElement.alt = "Image not available";
                 document.querySelector('.loading-screen').style.display = 'none';
            }
        }

        function countdown() { /* Timer logic placeholder */ }
        function resetTime() { clearTimeout(tm); }

        function showWrongList() { displayListInModal(wrongList, "你答錯的"); }
        function showCorrectList() { displayListInModal(correctList, "你答對的"); }

        function displayListInModal(list, title) {
            let modal = document.getElementById('modal');
            let modalBody = document.getElementById('modalBody');
            let content = `<h2>${title} (${list.length})</h2>`;

            if (list.length === 0) {
                content += `<p>你還沒有${title === "你答對的" ? "答對的" : "答錯的"}欸⋯</p>`;
            } else {
                content += '<ol>';
                list.forEach(item => {
                    if (!item) return;
                    content += '<li>';
                    if (item.path) {
                        content += `<img src="${item.path}" alt="Image for ${item.answer?.[0] || 'item'}" style="max-width: 200px; margin-bottom: 8px; border-radius: 4px;">`;
                    } else { content += '<p><i>（沒跑出圖片）</i></p>'; }
                    const answerText = Array.isArray(item.answer) ? item.answer.join(' / ') : 'N/A';
                    content += `<p><strong>答案：</strong>${answerText}</p>`;
                    const explanationText = item.explanation?.trim();
                     if (explanationText && explanationText !== "\"\"" && explanationText !== "\"\"") { // Fixed check
                        const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                        content += `<p style="font-size: 0.9rem; color: #4B5563;"><em>解釋：</em>${sanitizedExplanation}</p>`;
                     }
                    content += '</li>';
                });
                content += '</ol>';
            }
            modalBody.innerHTML = content;
            modal.style.display = "flex";
        }

        function adjustPlaceholder() {
            const inputElement = document.getElementById('answer');
            if (!inputElement) return;
            const desktopBreakpoint = 1024;
            if (window.innerWidth >= desktopBreakpoint) {
                inputElement.placeholder = '把答案打在這，你可以偷按按看 / 看看';
            } else {
                inputElement.placeholder = '把答案打在這';
            }
        }

    </script>
</body>
</html>
