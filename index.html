<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="Parasite Game">
    <meta name="keywords" content="parasites">
    <link rel="icon" href="icon.png" type="image/png">
    <script type="text/JavaScript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.js"></script>
    <title>Parasite Quiz</title>
    <!-- Using a simple sans-serif font stack -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        @font-face {
            font-family: 'Germgoth';
            src: url('fonts/Germgoth.woff') format('woff');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        .flashcard-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #222;
            font-family: "Germgoth", serif;
            margin-bottom: 5px;
            text-align: center;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #ffffff; /* White background */
            color: #1C1C1E; /* Default text color */
        }

        /* Start screen styles (keeping minimal) */
        .start-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .start-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 30px;
            color: #1C1C1E;
            font-family: "Germgoth", serif;
        }
        .start-button {
            padding: 12px 28px;
            font-size: 1rem;
            background-color: #4F46E5; /* Blue */
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .start-button:hover {
            background-color: #4338CA; /* Darker Blue */
        }
        .footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.9rem;
            color: #aaa;
        }
        .footer a {
            color: #aaa;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }

        /* Game Screen */
        .flashcard-container {
            width: 100%;
            height: 100%;
            display: none; /* Hidden initially */
            flex-direction: column;
            background-color: #ffffff;
            padding: 20px;
            position: relative;
            max-width: 800px; /* Limit max width for better desktop view */
            margin: 0 auto; /* Center container */
        }

        /* Progress Bar Area */
        .progress {
            display: flex;
            justify-content: space-between; /* Space out items */
            margin-bottom: 10px; /* Space below progress */
            gap: 10px; /* Space between items */
        }
        .progress-item {
            display: flex;
            align-items: center;
            padding: 6px 12px; /* Padding inside item */
            border-radius: 16px; /* Rounded corners */
            font-size: 1rem; /* Font size */
            font-weight: 500; /* Medium weight */
            background-color: #F3F4F6; /* Light gray background */
            color: #374151; /* Gray text */
            cursor: pointer; /* Indicate clickable */
            transition: background-color 0.2s ease;
        }
        .progress-item:hover {
            background-color: #E5E7EB; /* Slightly darker gray on hover */
        }
        .progress-number-orange {
            margin-right: 6px; /* Space between number and text */
            color: #FB923C; /* Orange */
            font-weight: 600; /* Bolder number */
        }
        .progress-number-green {
            margin-left: 6px; /* Space between text and number */
            color: #34D399; /* Green */
            font-weight: 600; /* Bolder number */
        }

        /* Image Area (replaces Chinese text) */
        .card-content {
            position: relative;
            flex-grow: 1; /* Takes remaining vertical space */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent image overflow */
            margin-bottom: 24px; /* Space below image */
            border-radius: 8px; /* Optional: round corners for image container */
            background-color: #F9FAFB; /* Very light gray background for contrast */
        }
        .loading-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%; /* Cover the card content area */
            background-color: #F9FAFB;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            border-radius: 8px;
        }
        .spinner {
            border: 3px solid #E5E7EB; /* Light gray border */
            border-top: 3px solid #4F46E5; /* Blue spinner part */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card-content img {
            display: block; /* Remove extra space below image */
            max-width: 100%;
            max-height: 100%; /* Fill the container height */
            object-fit: contain; /* Scale image while preserving aspect ratio */
            transition: opacity 0.3s ease;
            opacity: 0; /* Hidden until loaded */
            border-radius: 8px; /* Match container rounding */
        }
        .card-content img.loaded {
            opacity: 1; /* Show when loaded */
        }

        /* Answer Area */
        .your-answer-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6B7280; /* Medium gray */
            margin-bottom: 8px; /* Space below label */
        }
        .answer-input-container {
            margin-bottom: 16px; /* Space below input */
        }
        .answer-input {
            width: 100%;
            padding: 12px 16px; /* Comfortable padding */
            font-size: 1rem; /* Standard input font size */
            border: 1px solid #D1D5DB; /* Gray border */
            border-radius: 8px; /* Rounded corners */
            background-color: #F9FAFB; /* Light background */
            color: #1F2937; /* Dark text */
            outline: none; /* Remove default outline */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .answer-input::placeholder {
            color: #9CA3AF; /* Lighter placeholder text */
        }
        .answer-input:focus {
            border-color: #4F46E5; /* Blue border on focus */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2); /* Subtle focus ring */
        }

        /* Bottom Buttons Area */
        .bottom-buttons {
            display: flex;
            justify-content: flex-end; /* Align buttons to the right */
            align-items: center; /* Vertically align buttons */
            gap: 12px; /* Space between buttons */
        }
        .dont-know-button, .answer-button {
            padding: 10px 20px; /* Button padding */
            font-size: 1rem; /* Button font size */
            font-weight: 500; /* Medium weight */
            border: none;
            border-radius: 8px; /* Rounded corners */
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
        }
        .dont-know-button {
            background-color: transparent; /* No background */
            color: #4F46E5; /* Blue text */
        }
        .dont-know-button:hover {
            background-color: rgba(79, 70, 229, 0.05); /* Very light blue background on hover */
        }
        .answer-button {
            background-color: #4F46E5; /* Blue background */
            color: #ffffff; /* White text */
        }
        .answer-button:hover {
            background-color: #4338CA; /* Darker blue on hover */
        }
        .dont-know-button:active, .answer-button:active {
            transform: scale(0.98); /* Slight scale down on click */
        }


        /* 詳解區塊 */
        .card-answer {
          display: none;
          position: absolute;
          bottom: 10px;
          left: 20px;
          right: 20px;
          background-color: rgba(250, 250, 250, 0.8);
          padding: 15px;
          border-radius: 8px;
          font-size: 1.2rem;
          z-index: 3;
          flex-direction: column;
          gap: 10px;
        }
        /* 改良後的下一題按鈕 */
        .next-button {
          display: block;
          padding: 10px 20px;
          font-size: 1.2rem;
          background-color: #f9f9f9;
          color: #fc9d38;
          border: 2px solid #fc9d38;
          border-radius: 15px;
          cursor: pointer;
          transition: all 0.3s ease;
          position: relative;
          overflow: hidden;
          font-weight: 600;
          letter-spacing: 0.5px;
          align-self: flex-end;
          margin-top: 10px;
        }
        .next-button::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(120deg, transparent, rgba(255,255,255,0.3), transparent);
          transition: all 0.6s;
        }
        .next-button:hover::before {
          left: 100%;
        }
        .next-button:hover {
          background-color: #fc9d38;
          color: white;
          transform: translateY(-2px);
        }
        .next-button:active {
          transform: scale(0.95);
        }

        /* Modal styles (keeping minimal) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            width: 90%;
            max-width: 600px;
            max-height: 90%; /* Limit height */
            overflow-y: auto; /* Add scroll if content overflows */
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        .close {
            position: absolute;
            top: 12px;
            right: 16px;
            font-size: 1.8rem;
            font-weight: bold;
            color: #9CA3AF;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover { color: #1F2937; }
        .modal-content h2 {
          font-size: 1.25rem; /* 20px */
          margin-bottom: 16px;
          color: #111827; /* Darker heading */
        }
        .modal-content p {
          font-size: 1rem; /* 16px */
          line-height: 1.6;
          margin-bottom: 12px;
          color: #374151; /* Slightly lighter text */
        }
        .modal-content ol {
            padding-left: 20px;
            margin-bottom: 16px;
        }
        .modal-content li {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #E5E7EB; /* Light separator */
        }
         .modal-content li:last-child {
            border-bottom: none;
        }
        .modal-content img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #E5E7EB;
        }

    </style>
</head>
<body onload="init();">

    <!-- Start Screen (Unchanged Logic) -->
    <div class="start-screen">
        <div class="start-title">Parasitology</div>
        <button id="startGame" class="start-button">Start</button>
        <div class="footer">
          <a href="https://christmaskid.github.io/parasite_game/" target="_blank">前往初版</a>｜
          <a href="https://line.me/ti/p/~jedieason" target="_blank">問題回報</a>｜
          <a href="profile.mobileconfig" download="Parasite.mobileconfig">iOS下載</a>
        </div>
        <!-- Footer removed for cleaner look matching target -->
    </div>

    <!-- Game Screen (Modified Layout) -->  
    <div class="flashcard-container">

        <div class="flashcard-title">Parasitology</div>
        <div class="progress">
            <div class="progress-item" id="wrongArea">
                <span class="progress-number-orange" id="wrong">0</span>
                <span>Wrong</span> <!-- Changed text to English -->
            </div>
            <div class="progress-item" id="correctArea">
                <span>Correct</span> <!-- Changed text to English -->
                <span class="progress-number-green" id="correct">0</span>
            </div>
        </div>

        <!-- Image Content Area -->
        <div class="card-content">
            <div class="loading-screen">
                <div class="spinner"></div>
            </div>
            <!-- Image will be loaded here by JS -->
            <img id="image" onload="this.classList.add('loaded'); document.querySelector('.loading-screen').style.display='none';" src="" alt="Parasite Image">
            <!-- Hidden Answer/Explanation Area (for JS logic) -->
        </div>
        <div class="card-answer">
            <div id="showAnswer"></div>
            <div id="showExplanation"></div>
            <button id="next" class="next-button">Next</button> <!-- Changed text -->
        </div>
        <!-- Answer Input Area -->
        <div class="your-answer-label">Your answer</div>
        <div class="answer-input-container">
            <input id="answer" type="text" placeholder="Type the answer" class="answer-input">
        </div>

        <!-- Bottom Buttons Area -->
        <div class="bottom-buttons">
            <button id="dontKnow" class="dont-know-button">Don't know?</button>
            <button id="submitAnswer" class="answer-button">Answer</button>
        </div>

    </div>

    <!-- Modal (Unchanged Logic) -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span id="closeModal" class="close">×</span>
            <div id="modalBody">
                <!-- Content will be dynamically injected by JS -->
            </div>
        </div>
    </div>

    <script>
        // --- Original JavaScript (with minor adjustments for new IDs) ---
        var TIME = 31; // Timer duration
        var numOfProbs;
        var tm; // timer (global)
        var data; // answersheet
        var x; // index of current image/question
        var state = 0; // Game state (0: start, 1: answering, 2: showing answer)
        var correct = 0;
        var wrong = 0;
        var total = 0; // Total questions answered in this cycle
        var viewing = false; // Flag to prevent actions while answer is shown
        var done; // Array to track shown questions
        var correctList = []; // List of correctly answered items
        var wrongList = []; // List of incorrectly answered items

        // Function to parse answers that might have multiple options separated by " / "
        function parseMultiAns(data) {
            if (!data) return []; // Handle case where data might be null/undefined
            // Using Object.values might be cleaner if keys aren't important here
            Object.values(data).forEach(item => {
                if (item && typeof item.answer === 'string') {
                    item.answer = item.answer.split(" / ").map(s => s.trim()).filter(s => s); // Split, trim, remove empty
                } else if (!item || typeof item.answer === 'undefined') {
                    // Handle items without an answer property if necessary
                    item.answer = []; // Default to empty array
                }
            });
            return data;
        }

        // Handle Enter key press for submitting answer or moving to next question
        function enterKeyEvent(event) {
            if (event.key === 'Enter') { // Use event.key for modern browsers
                 if (!viewing && document.getElementById("answer").value.trim() !== "") {
                    // If answering and input is not empty, submit answer
                    submitUserAnswer();
                } else if (viewing) {
                    // If viewing answer, proceed to next question
                    nextProb();
                }
            }
        }

        // Initialize the game - load data and set up start screen
        function init() {
            $(document).ready(function () {
                // Use .fail() for better error handling with $.get
                $.get("./answersheet.csv")
                    .done(function (CSVdata) {
                        try {
                            data = $.csv.toObjects(CSVdata);
                            numOfProbs = data.length; // Use length for array
                            if (numOfProbs === 0) throw new Error("No data loaded from CSV.");
                            data = parseMultiAns(data);

                            var btn = document.getElementById("startGame");
                            var startHandler = function () {
                                document.querySelector('.start-screen').style.display = 'none';
                                document.querySelector('.flashcard-container').style.display = 'flex';
                                document.removeEventListener("keypress", enterPressStart); // Remove start listener
                                state = 1; // Set game state to answering
                                done = new Array(numOfProbs).fill(false); // Initialize done array
                                correct = 0;
                                wrong = 0;
                                total = 0;
                                document.getElementById("correct").innerHTML = correct;
                                document.getElementById("wrong").innerHTML = wrong;
                                correctList = [];
                                wrongList = [];
                                startGame(); // Start the main game loop
                            };

                            // Listener for Enter key on start screen
                            var enterPressStart = function (event) {
                                if (event.key === 'Enter') startHandler();
                            };

                            btn.addEventListener("click", startHandler);
                            document.addEventListener("keypress", enterPressStart); // Use keypress for Enter detection initially

                        } catch (error) {
                            console.error("Error processing CSV data:", error);
                            alert("Failed to load or process game data. Please check the console and the CSV file.");
                            // Optionally disable the start button or show an error message on screen
                            document.getElementById("startGame").disabled = true;
                            document.getElementById("startGame").textContent = "Error Loading Data";
                        }
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("Failed to load answersheet.csv:", textStatus, errorThrown);
                        alert("Could not load answersheet.csv. Please ensure the file exists and is accessible.");
                        // Disable start button
                         document.getElementById("startGame").disabled = true;
                         document.getElementById("startGame").textContent = "Error Loading Data";
                    });
            });
        }


        // Set up event listeners for the game screen
        function startGame() {
            document.addEventListener("keydown", enterKeyEvent); // Use keydown for Enter key during game
            document.getElementById("submitAnswer").addEventListener("click", submitUserAnswer);
            document.getElementById("dontKnow").addEventListener("click", showAnswer); // "Don't know" button shows the answer
            document.getElementById("next").addEventListener("click", nextProb); // "Next" button in the hidden answer area
            document.getElementById('wrongArea').addEventListener('click', showWrongList);
            document.getElementById('correctArea').addEventListener('click', showCorrectList);
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('modal').style.display = "none";
            });

            // Close modal if clicking outside the content
            window.onclick = function(event) {
                let modal = document.getElementById('modal');
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            };

             // Shortcut '/' to focus input
            document.addEventListener("keydown", function(e) {
                if (e.key === "/" && document.activeElement !== document.getElementById("answer")) {
                    e.preventDefault();
                    document.getElementById("answer").focus();
                }
            });

            nextProb(); // Load the first question
        }

        // Check if the user's input matches any of the correct answers
        function checkAns(input, ansArr) {
            if (!Array.isArray(ansArr)) return false; // Guard against non-array answers
            const normalizedInput = input.trim().toLowerCase(); // Normalize input
            return ansArr.some(ans => ans.trim().toLowerCase() === normalizedInput); // Case-insensitive check
        }

        // Update correct score and list
        function updateCorrect() {
            correct += 1;
            document.getElementById("correct").innerHTML = correct;
            if (data[x]) correctList.push(data[x]); // Add current item to correct list
            // Optional: Add combo alert or other feedback
             if (correct > 0 && correct % 10 === 0) { // Example: Message every 10 correct
               // console.log(`${correct} correct in a row!`);
             }
        }

        // Update wrong score and list
        function updateWrong() {
            wrong += 1;
            document.getElementById("wrong").innerHTML = wrong;
             if (data[x]) wrongList.push(data[x]); // Add current item to wrong list
        }

        // Function called when user clicks "Answer" button or presses Enter
        function submitUserAnswer() {
            if (viewing) return; // Prevent multiple submissions
            clearTimeout(tm); // Stop the timer

            var userAnswer = document.getElementById("answer").value;
            if (userAnswer.trim() === "") return; // Ignore empty submissions

            viewing = true; // Enter viewing state
            document.querySelector('.answer-input-container').style.visibility = 'hidden'; // Hide input
            document.querySelector('.bottom-buttons').style.visibility = 'hidden'; // Hide buttons
            document.querySelector('.your-answer-label').style.visibility = 'hidden'; // Hide label


            var showAnsDiv = document.getElementById("showAnswer");
            var cardAnswerDiv = document.querySelector(".card-answer");
            cardAnswerDiv.style.display = "flex"; // Show the answer/explanation area

            if (checkAns(userAnswer, data[x].answer)) {
                showAnsDiv.innerHTML = `<strong style="color: #10B981;">Correct!</strong> The answer is: ${data[x].answer.join(' / ')}`;
                hideExplanation(); // Don't show explanation for correct answers unless needed
                updateCorrect();
            } else {
                showAnsDiv.innerHTML = `<strong style="color: #EF4444;">Incorrect.</strong> The correct answer is: ${data[x].answer.join(' / ')}`;
                showExplanation(); // Show explanation for wrong answers
                updateWrong();
            }

            total++;
            checkCompletion(); // Check if all questions have been shown
        }

        // Hide the explanation area
        function hideExplanation() {
            document.getElementById("showExplanation").innerHTML = "";
            document.getElementById("showExplanation").style.display = "none";
        }

         // Show the answer (called by "Don't know?" button or timer expiry)
        function showAnswer() {
            if (viewing) return;
            clearTimeout(tm); // Stop the timer

            viewing = true; // Enter viewing state
             document.querySelector('.answer-input-container').style.visibility = 'hidden'; // Hide input
            document.querySelector('.bottom-buttons').style.visibility = 'hidden'; // Hide buttons
             document.querySelector('.your-answer-label').style.visibility = 'hidden'; // Hide label


            var showAnsDiv = document.getElementById("showAnswer");
            var cardAnswerDiv = document.querySelector(".card-answer");
            cardAnswerDiv.style.display = "flex"; // Show the answer/explanation area
            // Position answer overlay above the blank input area

            showAnsDiv.innerHTML = `<strong style="color: #F59E0B;">Answer:</strong> ${data[x].answer.join(' / ')}`;
            showExplanation(); // Show explanation when user didn't know
            updateWrong(); // Count "Don't know" as wrong

            total++;
            checkCompletion(); // Check if all questions have been shown
        }

        // Display the explanation for the current question
        function showExplanation() {
            var expDiv = document.getElementById("showExplanation");
            const explanationText = data[x]?.explanation?.trim(); // Optional chaining and trim
            if (!explanationText || explanationText === "\"\"" || explanationText === "") {
                expDiv.innerHTML = "<i>No explanation available for this item.</i>";
            } else {
                // Basic sanitization: replace potential script tags (more robust needed for untrusted content)
                const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                expDiv.innerHTML = `<strong>Explanation:</strong> ${sanitizedExplanation}`;
            }
             expDiv.style.display = "block"; // Ensure it's visible
        }

        // Reset UI and load the next question
        function nextProb() {
            // Hide answer area, show input area
            document.querySelector('.card-answer').style.display = 'none';
             document.querySelector('.answer-input-container').style.visibility = 'visible';
            document.querySelector('.bottom-buttons').style.visibility = 'visible';
             document.querySelector('.your-answer-label').style.visibility = 'visible';

            viewing = false; // Exit viewing state
            resetTime(); // Reset and start timer
            countdown();
            updateImage(); // Load new image
            document.getElementById("answer").value = ""; // Clear input field
            document.getElementById("answer").focus(); // Focus on input field
            document.getElementById("showAnswer").innerHTML = ""; // Clear previous answer text
            document.getElementById("showExplanation").innerHTML = ""; // Clear previous explanation
        }

        // Check if all questions are done and reset if needed
        function checkCompletion() {
             // Check if all 'done' flags are true
             const allDone = done.every(status => status === true);
             if (allDone) {
                 alert("You have completed all questions! The cycle will now restart.");
                 // Reset the 'done' array to start over
                 done.fill(false);
                 total = 0; // Reset total count for the new cycle
             }
        }


        // Select a new, unseen image index
        function pickNewImage() {
             // Find indices of questions not yet done
            const availableIndices = [];
            for (let i = 0; i < numOfProbs; i++) {
                if (!done[i]) {
                    availableIndices.push(i);
                }
            }

            if (availableIndices.length === 0) {
                // This case should be handled by checkCompletion, but as a fallback:
                console.warn("All questions shown, restarting cycle.");
                done.fill(false); // Reset all
                // Recalculate available indices (will include all now)
                for (let i = 0; i < numOfProbs; i++) availableIndices.push(i);
                if (availableIndices.length === 0) return -1; // Should not happen if numOfProbs > 0
            }

            // Pick a random index from the available ones
            const randomIndex = Math.floor(Math.random() * availableIndices.length);
            const selectedIndex = availableIndices[randomIndex];

            done[selectedIndex] = true; // Mark as done
            return selectedIndex;
        }

        // Update the image display
        function updateImage() {
            document.querySelector('.loading-screen').style.display = 'flex'; // Show spinner
            var imageElement = document.getElementById("image");
            imageElement.classList.remove('loaded'); // Prepare for new image
            imageElement.src = ""; // Clear previous image src

            x = pickNewImage(); // Get index of the next question
             if (x === -1) { // Handle error case where no image could be picked
                console.error("Could not pick a new image index.");
                // Maybe display an error message or stop the game
                return;
            }

            const picref = data[x]?.path; // Get image path safely

            if (picref) {
                 imageElement.setAttribute('src', picref);
                 // Alt text for accessibility
                 const altText = data[x]?.answer?.[0] || `Parasite image ${x + 1}`;
                 imageElement.setAttribute('alt', `Image for: ${altText}`);
            } else {
                 console.warn(`No image path found for index ${x}.`);
                 // Handle missing image path - maybe show a placeholder or skip?
                 imageElement.alt = "Image not available";
                 // Hide loading spinner immediately if no image src is set
                 document.querySelector('.loading-screen').style.display = 'none';
                 // Consider skipping to the next question automatically or showing text
                 // nextProb(); // Example: skip this question
            }
        }


        // Timer countdown logic
        function countdown() {
            // Timer logic removed as it's not in the target UI
            // If you want to add it back, uncomment the following lines
            // and add a timer display element in the HTML.

            // var show = document.getElementById("timerDisplay"); // Assuming you add <div id="timerDisplay"></div>
            // if (!show) return; // Exit if timer display doesn't exist
            // let currentTime = parseInt(show.innerHTML || TIME, 10);
            // if (currentTime > 0 && !viewing) {
            //     currentTime -= 1;
            //     show.innerHTML = currentTime;
            //     if (currentTime <= 10) show.style.color = "#EF4444"; // Red color for last 10 seconds
            //     tm = window.setTimeout(countdown, 1000);
            // } else if (currentTime === 0 && !viewing) {
            //     showAnswer(); // Time's up, show the answer
            // }
        }

        // Reset timer display and clear timeout
        function resetTime() {
            clearTimeout(tm); // Clear any existing timer
             // Timer logic removed as it's not in the target UI
            // If you add it back, reset its appearance here:
            // var timerDisplay = document.getElementById("timerDisplay");
            // if (timerDisplay) {
            //     timerDisplay.innerHTML = TIME; // Reset display to initial time
            //     timerDisplay.style.color = "#1F2937"; // Reset color
            // }
        }

         // Function to display the list of wrong answers in the modal
        function showWrongList() {
            displayListInModal(wrongList, "Incorrect Answers");
        }

        // Function to display the list of correct answers in the modal
        function showCorrectList() {
            displayListInModal(correctList, "Correct Answers");
        }

        // Helper function to display a list (correct or wrong) in the modal
        function displayListInModal(list, title) {
            let modal = document.getElementById('modal');
            let modalBody = document.getElementById('modalBody');
            let content = `<h2>${title} (${list.length})</h2>`; // Show count in title

            if (list.length === 0) {
                content += `<p>You haven't ${title === "Correct Answers" ? "answered any questions correctly" : "made any mistakes"} yet.</p>`;
            } else {
                content += '<ol>';
                // Use a Set to store displayed image paths to avoid duplicates if needed,
                // or simply iterate through the list as it preserves order.
                for (let item of list) {
                    if (!item) continue; // Skip if item is somehow undefined

                    content += '<li>';
                    // Display image if path exists
                    if (item.path) {
                         // Added width limit for consistency in modal
                        content += `<img src="${item.path}" alt="Image for ${item.answer?.[0] || 'item'}" style="max-width: 200px; margin-bottom: 8px; border-radius: 4px;">`;
                    } else {
                         content += '<p><i>(No image associated)</i></p>';
                    }
                    // Display answer(s)
                    const answerText = Array.isArray(item.answer) ? item.answer.join(' / ') : 'N/A';
                    content += `<p><strong>Answer:</strong> ${answerText}</p>`;

                    // Display explanation if it exists and is meaningful
                    const explanationText = item.explanation?.trim();
                     if (explanationText && explanationText !== "\"\"") {
                        const sanitizedExplanation = explanationText.replace(/<script.*?>.*?<\/script>/gi, '');
                        content += `<p style="font-size: 0.9rem; color: #4B5563;"><em>Explanation:</em> ${sanitizedExplanation}</p>`;
                    }
                    content += '</li>';
                }
                content += '</ol>';
            }
            modalBody.innerHTML = content;
            modal.style.display = "flex"; // Show the modal
        }

    </script>
</body>
</html>
